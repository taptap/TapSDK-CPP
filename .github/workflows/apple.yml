name: Apple CI

on:
  push:
    branches: [ "dev", "new_dev" ]
  pull_request:
    branches: [ "dev" ]

jobs:
  build:
    name: Build and Test default scheme using any available iPhone simulator
    runs-on: macos-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: Set Default Scheme
        run: |
          brew install ninja

      - name: Build ios
        run: |
          cd scripts
          chmod +x build-ios.sh
          ./build-ios.sh

      - name: Build ios-sim
        run: |
          cd scripts
          chmod +x build-ios-sim.sh
          ./build-ios-sim.sh

      - name: Build tvos
        run: |
          cd scripts
          chmod +x build-tvos.sh
          ./build-tvos.sh

      - name: Build tvos-sim
        run: |
          cd scripts
          chmod +x build-tvos-sim.sh
          ./build-tvos-sim.sh

      - name: Build mac-a64
        run: |
          cd scripts
          chmod +x build-mac-a64.sh
          ./build-mac-a64.sh

      - name: Build mac-x64
        run: |
          cd scripts
          chmod +x build-mac-x64.sh
          ./build-mac-x64.sh

      - name: pack sdks
        run: |
          mkdir builds
          mkdir builds/appletvos
          mkdir builds/appletvsimulator
          mkdir builds/iphoneos
          mkdir builds/iphonesimulator
          mkdir builds/macos-arm64
          mkdir builds/macos-x86_64
          cp -r ios/build-tvos/source/sdk/tds_core.framework  builds/appletvos/tds_core.framework
          cp -r ios/build-tvos-sim/source/sdk/tds_core.framework  builds/appletvsimulator/tds_core.framework
          cp -r ios/build-ios/source/sdk/tds_core.framework  builds/iphoneos/tds_core.framework
          cp -r ios/build-ios-sim/source/sdk/tds_core.framework  builds/iphonesimulator/tds_core.framework
          cp -r build-a64/source/sdk/tds_core.framework  builds/macos-arm64/tds_core.framework
          cp -r build-x64/source/sdk/tds_core.framework  builds/macos-x64_64/tds_core.framework
          cp build-a64/source/bindings/csharp/libbindings-csharp.dylib  builds/macos-arm64/libbindings-csharp.dylib
          cp build-x64/source/bindings/csharp/libbindings-csharp.dylib  builds/macos-x64_64/libbindings-csharp.dylib
          zip -r builds.zip builds

      - name: Upload sdks
        uses: actions/upload-artifact@v3.1.2
        with:
          # Artifact name
          name: sdks.zip
          # A file, directory or wildcard pattern that describes what to upload
          path: builds.zip
